{% extends "base.html" %}

{% block title %}Thermal Analysis - Coal Spontaneous Combustion Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-5 text-primary">
                <i class="fas fa-thermometer-half me-3"></i>
                Thermal Image Analysis
            </h1>
            <p class="lead text-muted">
                Advanced thermal simulation of coal samples from bituminous dataset
            </p>
        </div>

        {% if error %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        </div>
        {% endif %}

        <!-- Instructions -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>How Thermal Analysis Works
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-info">Image Processing</h6>
                        <ul class="small">
                            <li>Analyzes coal texture, brightness, and particle distribution</li>
                            <li>Identifies potential hot spots based on coal characteristics</li>
                            <li>Simulates heat diffusion patterns using advanced algorithms</li>
                            <li>Generates realistic environmental conditions</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning">Thermal Simulation</h6>
                        <ul class="small">
                            <li>Creates thermal maps showing temperature distribution</li>
                            <li>Applies environmental factors (humidity, ventilation, storage time)</li>
                            <li>Identifies critical temperature zones and hot spots</li>
                            <li>Combines with traditional analysis methods for comprehensive assessment</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coal Image Gallery -->
        {% if images %}
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-images me-2"></i>
                    Bituminous Coal Dataset ({{ images|length }} samples)
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for image in images[:20] %}  <!-- Limit display to first 20 images -->
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="position-relative">
                                <img src="{{ url_for('dataset_image', filename=image) }}" 
                                     class="card-img-top" 
                                     alt="Coal Sample {{ image }}"
                                     style="height: 200px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-dark bg-opacity-75">{{ image }}</span>
                                </div>
                            </div>
                            <div class="card-body text-center">
                                <h6 class="card-title">Sample {{ image.split('.')[0] }}</h6>
                                <a href="{{ url_for('analyze_thermal_image', image_name=image) }}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="fas fa-thermometer-half me-1"></i>
                                    Analyze Thermal
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if images|length > 20 %}
                <div class="text-center mt-3">
                    <p class="text-muted">Showing first 20 of {{ images|length }} available samples</p>
                    <a href="{{ url_for('batch_thermal_analysis') }}" class="btn btn-info btn-lg">
                        <i class="fas fa-chart-bar me-2"></i>
                        Run Batch Analysis on All Samples
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center">
                <div class="py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Coal Images Found</h4>
                    <p class="text-muted">
                        Please ensure the dataset/Bituminous folder contains coal sample images.
                    </p>
                    <div class="mt-4">
                        <p class="small text-muted">
                            Expected path: <code>dataset/Bituminous/*.jpg</code>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Analysis Features -->
        <div class="row mt-5">
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white text-center">
                        <i class="fas fa-eye fa-2x mb-2"></i>
                        <h6 class="mb-0">Image Feature Analysis</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success me-2"></i>Brightness & contrast analysis</li>
                            <li><i class="fas fa-check text-success me-2"></i>Texture variance detection</li>
                            <li><i class="fas fa-check text-success me-2"></i>Particle size estimation</li>
                            <li><i class="fas fa-check text-success me-2"></i>Edge density calculation</li>
                            <li><i class="fas fa-check text-success me-2"></i>Color space analysis</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-warning">
                    <div class="card-header bg-warning text-dark text-center">
                        <i class="fas fa-fire fa-2x mb-2"></i>
                        <h6 class="mb-0">Thermal Simulation</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success me-2"></i>Heat distribution modeling</li>
                            <li><i class="fas fa-check text-success me-2"></i>Hot spot identification</li>
                            <li><i class="fas fa-check text-success me-2"></i>Temperature gradient analysis</li>
                            <li><i class="fas fa-check text-success me-2"></i>Environmental factor integration</li>
                            <li><i class="fas fa-check text-success me-2"></i>Thermal colormap visualization</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-success">
                    <div class="card-header bg-success text-white text-center">
                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                        <h6 class="mb-0">Risk Assessment</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success me-2"></i>Combined thermal + chemical analysis</li>
                            <li><i class="fas fa-check text-success me-2"></i>Multi-parameter risk scoring</li>
                            <li><i class="fas fa-check text-success me-2"></i>Safety recommendations</li>
                            <li><i class="fas fa-check text-success me-2"></i>Critical zone identification</li>
                            <li><i class="fas fa-check text-success me-2"></i>Preventive action guidance</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-calculator me-2"></i>Manual Analysis
                    </a>
                    {% if images %}
                    <a href="{{ url_for('batch_thermal_analysis') }}" class="btn btn-outline-info">
                        <i class="fas fa-chart-bar me-2"></i>Batch Analysis
                    </a>
                    {% endif %}
                    <a href="{{ url_for('about') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-info-circle me-2"></i>Learn More
                    </a>
                </div>
            </div>
        </div>

        <!-- Technical Info -->
        <div class="card mt-5">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Technical Implementation
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Environmental Scenarios</h6>
                        <div class="row">
                            <div class="col-6">
                                <ul class="list-unstyled small">
                                    <li><strong>Normal:</strong> Standard conditions</li>
                                    <li><strong>Hot Day:</strong> High temperature, low humidity</li>
                                </ul>
                            </div>
                            <div class="col-6">
                                <ul class="list-unstyled small">
                                    <li><strong>Humid:</strong> High moisture conditions</li>
                                    <li><strong>Poor Ventilation:</strong> Low airflow scenario</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning">Analysis Parameters</h6>
                        <ul class="list-unstyled small">
                            <li><strong>Temperature Range:</strong> 15°C - 200°C</li>
                            <li><strong>Hot Spot Detection:</strong> Automated identification</li>
                            <li><strong>Heat Diffusion:</strong> Gaussian blur modeling</li>
                            <li><strong>Risk Integration:</strong> Thermal + Chemical scoring</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add loading states for thermal analysis buttons
    document.addEventListener('DOMContentLoaded', function() {
        const analyzeButtons = document.querySelectorAll('a[href*="analyze_thermal_image"]');
        
        analyzeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
                this.classList.add('disabled');
                
                // Re-enable after some time if navigation doesn't occur
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('disabled');
                }, 10000);
            });
        });
    });

    // Image lazy loading for better performance
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        });

        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
</script>
{% endblock %}