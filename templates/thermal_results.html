{% extends "base.html" %}

{% block title %}Thermal Analysis Results - Coal Spontaneous Combustion Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-6 text-primary">
                <i class="fas fa-thermometer-half me-3"></i>
                Thermal Analysis Results
            </h1>
            <p class="lead text-muted">Advanced Thermal Simulation Report for {{ results.image_info.filename }}</p>
        </div>

        <!-- Sample Information -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Sample Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Image File:</strong> {{ results.image_info.filename }}
                    </div>
                    <div class="col-md-3">
                        <strong>Scenario:</strong> {{ results.image_info.scenario }}
                    </div>
                    <div class="col-md-3">
                        <strong>Coal Type:</strong> Bituminous
                    </div>
                    <div class="col-md-3">
                        <strong>Analysis Date:</strong> {{ results.image_info.analysis_date }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined Risk Assessment -->
        <div class="alert alert-{{ results.combined_risk_assessment.color }} alert-dismissible fade show" role="alert">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="alert-heading mb-2">
                        {% if results.combined_risk_assessment.overall_risk == 'CRITICAL' %}
                            <i class="fas fa-exclamation-triangle me-2"></i>CRITICAL RISK
                        {% elif results.combined_risk_assessment.overall_risk == 'HIGH' %}
                            <i class="fas fa-exclamation-circle me-2"></i>HIGH RISK
                        {% elif results.combined_risk_assessment.overall_risk == 'MODERATE' %}
                            <i class="fas fa-info-circle me-2"></i>MODERATE RISK
                        {% else %}
                            <i class="fas fa-check-circle me-2"></i>LOW RISK
                        {% endif %}
                        - Combined Assessment
                    </h4>
                    <p class="mb-1">
                        <strong>Overall Score:</strong> {{ "%.1f"|format(results.combined_risk_assessment.risk_score) }}/100
                    </p>
                    <small>
                        Standard Analysis: {{ "%.1f"|format(results.combined_risk_assessment.standard_risk_score) }}/100 | 
                        Thermal Analysis: {{ "%.1f"|format(results.combined_risk_assessment.thermal_risk_score) }}/100
                    </small>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-{{ results.combined_risk_assessment.color }}" 
                             role="progressbar" 
                             style="width: {{ results.combined_risk_assessment.risk_score }}%"
                             aria-valuenow="{{ results.combined_risk_assessment.risk_score }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ "%.1f"|format(results.combined_risk_assessment.risk_score) }}%
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="progress" style="height: 15px;">
                                <div class="progress-bar bg-info" 
                                     style="width: {{ results.combined_risk_assessment.standard_risk_score }}%"
                                     title="Standard Analysis">
                                </div>
                            </div>
                            <small class="text-muted">Standard</small>
                        </div>
                        <div class="col-6">
                            <div class="progress" style="height: 15px;">
                                <div class="progress-bar bg-warning" 
                                     style="width: {{ results.combined_risk_assessment.thermal_risk_score }}%"
                                     title="Thermal Analysis">
                                </div>
                            </div>
                            <small class="text-muted">Thermal</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thermal Visualization -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-fire me-2"></i>Thermal Visualization
                </h5>
            </div>
            <div class="card-body text-center">
                {% if results.thermal_analysis.thermal_image %}
                <img src="data:image/png;base64,{{ results.thermal_analysis.thermal_image }}" 
                     class="img-fluid rounded shadow" 
                     alt="Thermal Analysis Visualization"
                     style="max-height: 400px;">
                {% else %}
                <p class="text-muted">Thermal visualization not available</p>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Temperature Statistics -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-thermometer-full me-2"></i>Temperature Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <tbody>
                                    <tr>
                                        <td><strong>Maximum Temperature</strong></td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if results.thermal_analysis.temperature_stats.max_temp > 120 %}danger{% elif results.thermal_analysis.temperature_stats.max_temp > 80 %}warning{% elif results.thermal_analysis.temperature_stats.max_temp > 50 %}info{% else %}success{% endif %} fs-6">
                                                {{ "%.1f"|format(results.thermal_analysis.temperature_stats.max_temp) }}°C
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Average Temperature</strong></td>
                                        <td class="text-end">
                                            <span class="badge bg-info fs-6">
                                                {{ "%.1f"|format(results.thermal_analysis.temperature_stats.avg_temp) }}°C
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Minimum Temperature</strong></td>
                                        <td class="text-end">
                                            <span class="badge bg-secondary fs-6">
                                                {{ "%.1f"|format(results.thermal_analysis.temperature_stats.min_temp) }}°C
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Hot Spot Count</strong></td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if results.thermal_analysis.temperature_stats.hot_spot_count > 10 %}danger{% elif results.thermal_analysis.temperature_stats.hot_spot_count > 5 %}warning{% else %}success{% endif %} fs-6">
                                                {{ results.thermal_analysis.temperature_stats.hot_spot_count }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Critical Area</strong></td>
                                        <td class="text-end">
                                            <span class="badge bg-{% if results.thermal_analysis.temperature_stats.critical_area_percentage > 20 %}danger{% elif results.thermal_analysis.temperature_stats.critical_area_percentage > 10 %}warning{% else %}success{% endif %} fs-6">
                                                {{ "%.1f"|format(results.thermal_analysis.temperature_stats.critical_area_percentage) }}%
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Temperature Range Indicator -->
                        <div class="mt-3">
                            <h6 class="text-secondary">Temperature Risk Zones</h6>
                            <div class="d-flex justify-content-between small">
                                <span class="badge bg-success">Safe<br>&lt;35°C</span>
                                <span class="badge bg-info">Watch<br>35-50°C</span>
                                <span class="badge bg-warning">Caution<br>50-80°C</span>
                                <span class="badge bg-danger">Critical<br>&gt;80°C</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Environmental Parameters -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud-sun me-2"></i>Environmental Conditions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <h6 class="text-secondary">Atmospheric</h6>
                                <ul class="list-unstyled small">
                                    <li><strong>Temperature:</strong> {{ "%.1f"|format(results.environmental_params.ambient_temperature) }}°C</li>
                                    <li><strong>Humidity:</strong> {{ "%.1f"|format(results.environmental_params.relative_humidity) }}%</li>
                                    <li><strong>Oxygen:</strong> {{ "%.1f"|format(results.environmental_params.oxygen_content) }}%</li>
                                    <li><strong>Pressure:</strong> {{ "%.1f"|format(results.environmental_params.atmospheric_pressure) }} kPa</li>
                                </ul>
                            </div>
                            <div class="col-6 mb-3">
                                <h6 class="text-secondary">Storage Conditions</h6>
                                <ul class="list-unstyled small">
                                    <li><strong>Wind Speed:</strong> {{ "%.1f"|format(results.environmental_params.wind_speed) }} m/s</li>
                                    <li><strong>Pile Height:</strong> {{ "%.1f"|format(results.environmental_params.pile_height) }} m</li>
                                    <li><strong>Storage Duration:</strong> {{ results.environmental_params.storage_duration }} days</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Environmental Risk Indicators -->
                        <div class="mt-3">
                            <h6 class="text-secondary">Risk Indicators</h6>
                            <div class="row">
                                <div class="col-6">
                                    {% if results.environmental_params.ambient_temperature > 35 %}
                                        <span class="badge bg-warning">High Temp</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal Temp</span>
                                    {% endif %}
                                    
                                    {% if results.environmental_params.relative_humidity > 80 %}
                                        <span class="badge bg-info">High Humidity</span>
                                    {% elif results.environmental_params.relative_humidity < 30 %}
                                        <span class="badge bg-warning">Low Humidity</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal Humidity</span>
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    {% if results.environmental_params.wind_speed < 0.5 %}
                                        <span class="badge bg-danger">Poor Ventilation</span>
                                    {% else %}
                                        <span class="badge bg-success">Good Ventilation</span>
                                    {% endif %}
                                    
                                    {% if results.environmental_params.pile_height > 6 %}
                                        <span class="badge bg-warning">Large Pile</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal Pile</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coal Properties and Calculated Indices -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-flask me-2"></i>Generated Coal Properties
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td><strong>Moisture Content</strong></td>
                                        <td class="text-end">{{ "%.2f"|format(results.coal_properties.moisture) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Volatile Matter</strong></td>
                                        <td class="text-end">{{ "%.2f"|format(results.coal_properties.volatile_matter) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ash Content</strong></td>
                                        <td class="text-end">{{ "%.2f"|format(results.coal_properties.ash) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Fixed Carbon</strong></td>
                                        <td class="text-end">{{ "%.2f"|format(results.coal_properties.fixed_carbon) }}%</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Total</strong></td>
                                        <td class="text-end"><strong>{{ "%.1f"|format(results.coal_properties.moisture + results.coal_properties.volatile_matter + results.coal_properties.ash + results.coal_properties.fixed_carbon) }}%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Coal Property Visualization -->
                        <div class="mt-3">
                            <h6 class="text-secondary">Composition Breakdown</h6>
                            <div class="progress mb-1" style="height: 25px;">
                                <div class="progress-bar bg-info" 
                                     style="width: {{ results.coal_properties.moisture }}%" 
                                     title="Moisture: {{ '%.1f'|format(results.coal_properties.moisture) }}%">M</div>
                                <div class="progress-bar bg-warning" 
                                     style="width: {{ results.coal_properties.volatile_matter }}%" 
                                     title="Volatile Matter: {{ '%.1f'|format(results.coal_properties.volatile_matter) }}%">VM</div>
                                <div class="progress-bar bg-secondary" 
                                     style="width: {{ results.coal_properties.ash }}%" 
                                     title="Ash: {{ '%.1f'|format(results.coal_properties.ash) }}%">A</div>
                                <div class="progress-bar bg-dark" 
                                     style="width: {{ results.coal_properties.fixed_carbon }}%" 
                                     title="Fixed Carbon: {{ '%.1f'|format(results.coal_properties.fixed_carbon) }}%">FC</div>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span><i class="fas fa-square text-info"></i> Moisture</span>
                                <span><i class="fas fa-square text-warning"></i> Volatile</span>
                                <span><i class="fas fa-square text-secondary"></i> Ash</span>
                                <span><i class="fas fa-square text-dark"></i> Fixed Carbon</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>Calculated Indices
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>Crossing Point Temperature</strong>
                                            <br><small class="text-muted">Lower = Higher risk</small>
                                        </td>
                                        <td class="text-end">
                                            {% if results.calculated_indices.cpt %}
                                                <span class="badge bg-{% if results.calculated_indices.cpt < 140 %}danger{% elif results.calculated_indices.cpt < 150 %}warning{% elif results.calculated_indices.cpt < 160 %}info{% else %}success{% endif %} fs-6">
                                                    {{ "%.1f"|format(results.calculated_indices.cpt) }}°C
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Liability Index</strong>
                                            <br><small class="text-muted">Higher = Higher risk</small>
                                        </td>
                                        <td class="text-end">
                                            {% if results.calculated_indices.liability_index %}
                                                <span class="badge bg-{% if results.calculated_indices.liability_index > 2.0 %}danger{% elif results.calculated_indices.liability_index > 1.0 %}warning{% else %}success{% endif %} fs-6">
                                                    {{ results.calculated_indices.liability_index }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>WITS Index</strong>
                                            <br><small class="text-muted">Higher = Higher risk</small>
                                        </td>
                                        <td class="text-end">
                                            {% if results.calculated_indices.wits_index %}
                                                <span class="badge bg-{% if results.calculated_indices.wits_index > 5.0 %}danger{% elif results.calculated_indices.wits_index > 2.0 %}warning{% else %}success{% endif %} fs-6">
                                                    {{ results.calculated_indices.wits_index }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Olpinski Index</strong>
                                            <br><small class="text-muted">Moisture-based indicator</small>
                                        </td>
                                        <td class="text-end">
                                            {% if results.calculated_indices.olpinski_index %}
                                                <span class="badge bg-info fs-6">
                                                    {{ results.calculated_indices.olpinski_index }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Factors -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-list-ul me-2"></i>Identified Risk Factors
                </h5>
            </div>
            <div class="card-body">
                {% if results.combined_risk_assessment.risk_factors %}
                    <div class="row">
                        {% for factor in results.combined_risk_assessment.risk_factors %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-arrow-right text-warning me-2"></i>
                                <span>{{ factor }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No specific risk factors identified.</p>
                {% endif %}
            </div>
        </div>

        <!-- Safety Recommendations -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Safety Recommendations
                </h5>
            </div>
            <div class="card-body">
                {% if results.recommendations %}
                    <div class="row">
                        {% for recommendation in results.recommendations %}
                        <div class="col-12 mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <span class="badge bg-success rounded-pill">{{ loop.index }}</span>
                                </div>
                                <div>
                                    <p class="mb-0">{{ recommendation }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No specific recommendations available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-4">
            <a href="{{ url_for('thermal_analysis') }}" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-arrow-left me-2"></i>Back to Thermal Analysis
            </a>
            <button onclick="window.print()" class="btn btn-secondary btn-lg me-3">
                <i class="fas fa-print me-2"></i>Print Report
            </button>
            <button onclick="downloadThermalReport()" class="btn btn-info btn-lg">
                <i class="fas fa-download me-2"></i>Download Data
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function downloadThermalReport() {
        const results = {{ results | tojson }};
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(results, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "thermal_analysis_" + results.image_info.filename + "_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // Print styles for thermal images
    const printStyles = `
        @media print {
            .btn, .alert-dismissible .btn-close {
                display: none !important;
            }
            .card {
                break-inside: avoid;
                margin-bottom: 1rem !important;
            }
            body {
                font-size: 11px !important;
            }
            .display-6 {
                font-size: 1.4rem !important;
            }
            img {
                max-width: 100% !important;
                height: auto !important;
            }
        }
    `;
    
    const styleSheet = document.createElement("style");
    styleSheet.innerText = printStyles;
    document.head.appendChild(styleSheet);
</script>
{% endblock %}